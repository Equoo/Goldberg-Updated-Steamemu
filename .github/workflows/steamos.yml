name: Build Goldberg Emulator for SteamOS (Dockerized)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  protobuf_static_steamos:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Restore protobuf cache
        uses: actions/cache@v3
        with:
          path: protobuf/
          key: protobuf-static-steamos-cache

      - name: Build protobuf static inside Docker
        run: |
          if [ -e ./protobuf/prefix ]; then
            echo "Protobuf already built, skipping..."
            exit 0
          fi

          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace tianon/steamos bash -c "
            apt update && apt -y install gcc-4.9 g++-4.9 git autotools-dev automake libtool g++-4.9-multilib gcc-4.9-multilib build-essential &&

            export BASE_PREFIX_PATH=\$(pwd)
            echo 'Base prefix path: '\$BASE_PREFIX_PATH

            mkdir deps
            cd deps

            git clone --branch 21.x https://github.com/protocolbuffers/protobuf.git
            cd protobuf

            sh autogen.sh
            ./configure 'CC=gcc-4.9 -m32' 'CXX=g++-4.9 -m32' CPPFLAGS='-fPIC -Ofast' CXXFLAGS='-fPIC -Ofast' --prefix=\$BASE_PREFIX_PATH/protobuf/prefix_x86/ --disable-shared --enable-static
            make -j\$(nproc) install
            make clean

            ./configure 'CC=gcc-4.9' 'CXX=g++-4.9' CPPFLAGS='-fPIC -Ofast' CXXFLAGS='-fPIC -Ofast' --prefix=\$BASE_PREFIX_PATH/protobuf/prefix/ --disable-shared --enable-static
            make -j\$(nproc) install
          "

      - name: Upload protobuf artifact
        uses: actions/upload-artifact@v4
        with:
          name: protobuf
          path: protobuf/

  build_steamos:
    needs: protobuf_static_steamos
    runs-on: debian-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download protobuf artifact
        uses: actions/download-artifact@v4
        with:
          name: protobuf
          path: protobuf

      - name: Build project inside Docker
        run: |
          apt-get update &&
          apt-get install -y --no-install-recommends ca-certificates &&
          sed -i 's|http://deb.debian.org|https://deb.debian.org|g' /etc/apt/sources.list &&
          apt-get update &&
          apt -y --fix-missing install gcc g++ git libtool build-essential libx11-dev libxext-dev libxi-dev libxrandr-dev libxinerama-dev libgl1-mesa-dev libglu1-mesa-dev

          echo 'System Info:'
          uname -a
          ls -lah

          ls -lah ./protobuf && echo "Protobuf directory exists"
          ls -lah ./protobuf/prefix && echo "Protobuf prefix directory exists"
          ls -lah ./protobuf/prefix/bin && echo "Protobuf prefix bin directory exists"
          ls -lah ./protobuf/prefix_x86 && echo "Protobuf prefix_x86 directory exists"
          ls -lah ./protobuf/prefix_x86/bin && echo "Protobuf prefix_x86 bin directory exists"

          chmod -R 755 ./protobuf

          sed -i 's|../protobuf/prefix|./protobuf/prefix|g' build_steamos.sh

          sh build_steamos.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: linux/
